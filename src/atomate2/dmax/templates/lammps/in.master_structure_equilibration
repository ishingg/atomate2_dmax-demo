{% raw %}
# Structure Equilibration Master Input
units            {{ units }}
atom_style       {{ atom_style }}
boundary         {{ boundary }}
dielectric       {{ dielectric }}
special_bonds    {{ special_bonds }}

pair_style       {{ pair_style }}
bond_style       {{ bond_style }}
angle_style      {{ angle_style }}
dihedral_style   {{ dihedral_style }}
improper_style   {{ improper_style }}
kspace_style     {{ kspace_style }}

read_data        {{ data_file }}

pair_modify      {{ pair_modify }}
neighbor         {{ neighbor }}
neigh_modify     {{ neigh_modify }}

thermo_style     {{ thermo_style }}
variable         sname   string {{ system_name }}
variable         timestep equal {{ timestep }}

variable         temperature equal {{ temperature }}
variable         pressure equal {{ pressure }}

# Minimization
print            "Starting conjugate-gradient minimization"
dump             MIN_data all custom 25 ${sname}.min.lammpstrj id type xu yu zu vx vy vz
thermo           25
min_style        cg
minimize         0 1.0e-6 5000 50000
undump           MIN_data

# NVT heating
print            "NVT heating"
velocity         all create 0.0 12345678 dist uniform
thermo           1000
dump             NVT_Heat_data all custom 1000 ${sname}.heat.lammpstrj id type xu yu zu vx vy vz fx fy fz
fix              NVT_Heat all nvt temp 1.0 ${temperature} 400
run              {{ heat_steps }}
unfix            NVT_Heat
undump           NVT_Heat_data

# NPT Equilibration (isotropic)
print            "NPT equilibration"
fix              NPT_Equil all npt temp ${temperature} ${temperature} 400 iso ${pressure} ${pressure} 5000.0
dump             NPT_Equil_data all custom 1000 ${sname}.${temperature}K.npt.lammpstrj id type xu yu zu vx vy vz fx fy fz
variable         latx equal lx
variable         laty equal ly
variable         latz equal lz
fix              cellavg all ave/time 1 250000 250000 v_latx v_laty v_latz file cell.dat
run              {{ npt_steps }}
unfix            cellavg
undump           NPT_Equil_data

# Final Equilibration
print            "Final NVT equilibration"
fix              NVT_Equil all nvt temp ${temperature} ${temperature} 400 tloop 10 ploop 10
dump             NVT_Equil_data all custom 1000 ${sname}.${temperature}K.prod.lammpstrj id type xu yu zu vx vy vz fx fy fz
run              {{ prod_steps }}
unfix            NVT_Equil
undump           NVT_Equil_data

write_restart    restart.equil
{% endraw %}
